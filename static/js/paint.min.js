function createPaint(a){var b=elt("canvas",{id:"canvas_draw",width:256,height:256}),c=b.getContext("2d"),d=elt("div",{class:"toolbar"});for(var e in controls)d.appendChild(controls[e](c));var f=elt("div",{class:"picturepanel"},b);a.appendChild(elt("div",null,f,d))}function elt(a,b){var c=document.createElement(a);if(b)for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);for(var e=2;e<arguments.length;e++){var f=arguments[e];"string"==typeof f&&(f=document.createTextNode(f)),c.appendChild(f)}return c}function relativePos(a,b){var c=b.getBoundingClientRect();return{x:Math.floor(a.clientX-c.left),y:Math.floor(a.clientY-c.top)}}function trackDrag(a,b){function c(d){removeEventListener("mousemove",a),removeEventListener("mouseup",c),b&&b(d)}addEventListener("mousemove",a),addEventListener("mouseup",c)}function loadImageURL(a,b){var c=document.createElement("img");c.addEventListener("load",function(){var b=a.fillStyle,d=a.lineWidth;a.canvas.width=c.width,a.canvas.height=c.height,a.drawImage(c,0,0),a.fillStyle=b,a.strokeStyle=b,a.lineWidth=d}),c.src=b}function randomPointInRadius(a){for(;;){var b=2*Math.random()-1,c=2*Math.random()-1;if(b*b+c*c<=1)return{x:b*a,y:c*a}}}function forEachNeighbor(a,b){b({x:a.x-1,y:a.y}),b({x:a.x+1,y:a.y}),b({x:a.x,y:a.y-1}),b({x:a.x,y:a.y+1})}function isSameColor(a,b,c){for(var d=4*(b.x+b.y*a.width),e=4*(c.x+c.y*a.width),f=0;f<4;f++)if(a.data[d+f]!=a.data[e+f])return!1;return!0}var controls=Object.create(null);controls.tool=function(a){var b=elt("select");for(var c in tools)b.appendChild(elt("option",null,c));return a.canvas.addEventListener("mousedown",function(c){1==c.which&&(tools[b.value](c,a),c.preventDefault())}),elt("span",null,"Tool: ",b)},controls.color=function(a){var b=elt("input",{type:"color"});return b.addEventListener("change",function(){a.fillStyle=b.value,a.strokeStyle=b.value}),elt("span",null,"  Color: ",b)},controls.brushSize=function(a){var b=elt("select"),c=[1,2,3,5,8,12,25,35,50,75,100];return c.forEach(function(a){b.appendChild(elt("option",{value:a},a+" pixels"))}),b.addEventListener("change",function(){a.lineWidth=b.value}),elt("span",null,"  Brush size: ",b)};var tools=Object.create(null);tools.Line=function(a,b,c){b.lineCap="round";var d=relativePos(a,b.canvas);trackDrag(function(a){b.beginPath(),b.moveTo(d.x,d.y),d=relativePos(a,b.canvas),b.lineTo(d.x,d.y),b.stroke()},c)},tools.Erase=function(a,b){b.globalCompositeOperation="destination-out",tools.Line(a,b,function(){b.globalCompositeOperation="source-over"})},tools.Text=function(a,b){var c=prompt("Text:","");if(c){var d=relativePos(a,b.canvas);b.font=Math.max(7,b.lineWidth)+"px sans-serif",b.fillText(c,d.x,d.y)}},tools.Spray=function(a,b){var c=b.lineWidth/2,d=c*c*Math.PI,e=Math.ceil(d/30),f=relativePos(a,b.canvas),g=setInterval(function(){for(var a=0;a<e;a++){var d=randomPointInRadius(c);b.fillRect(f.x+d.x,f.y+d.y,1,1)}},25);trackDrag(function(a){f=relativePos(a,b.canvas)},function(){clearInterval(g)})},tools.Rectangle=function(a,b){var c,d,e,f,g=a.clientX,h=a.clientY,i=elt("div",{class:"placeholder"}),j=relativePos(a,b.canvas),k=g-j.x,l=h-j.y;trackDrag(function(a){document.body.appendChild(i);var g=relativePos(a,b.canvas),h=j.x,m=j.y;h<g.x?(c=h,d=g.x):(c=g.x,d=h),m<g.y?(e=m,f=g.y):(e=g.y,f=m),i.style.background=b.fillStyle,i.style.left=c+k+"px",i.style.top=e+l+"px",i.style.width=d-c+"px",i.style.height=f-e+"px"},function(){b.fillRect(c,e,d-c,f-e),document.body.removeChild(i)})},tools["Pick Color"]=function(a,b){try{var c=relativePos(a,b.canvas),d=b.getImageData(c.x,c.y,1,1),e=d.data,f="";f+="rgb(";for(var g=0;g<e.length-1;g++)f+=e[g],g<2&&(f+=",");f+=")",b.fillStyle=f,b.strokeStyle=f}catch(a){if(!(a instanceof SecurityError))throw a;alert("Whoops! Looks like you don't have permission to do that!")}},tools["Flood Fill"]=function(a,b){for(var c=b.getImageData(0,0,b.canvas.width,b.canvas.height),d=relativePos(a,b.canvas),e=new Array(c.width*c.height),f=[d];f.length;){var g=f.pop(),h=g.x+g.y*c.width;e[h]||(b.fillRect(g.x,g.y,1,1),e[h]=!0,forEachNeighbor(g,function(a){a.x>=0&&a.x<c.width&&a.y>=0&&a.y<c.height&&isSameColor(c,d,a)&&f.push(a)}))}};var appDiv=document.querySelector("#paint-app");createPaint(appDiv);
